<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>首页</title>
	<link rel="stylesheet" href="lib/layui/css/layui.css">
	<script src="lib/layui/layui.js"></script>
	<!--<script src="js/websocket.js"></script>-->
</head>
<body>
<script>
    var mine = {};
    var chats = {
        name: '在线客服一' //名称
        , type: 'kefu' //聊天类型
        , avatar: '//tp1.sinaimg.cn/5619439268/180/40030060651/1' //头像
        , id: 1111111 //定义唯一的id方便你处理信息
    };
    var chat2 = {
        name: '在线客服二' //名称
        , type: 'kefu' //聊天类型
        , avatar: '//tp1.sinaimg.cn/5619439268/180/40030060651/1' //头像
        , id: 2222222 //定义唯一的id方便你处理信息
    };

    //初始化我的信息（我是客服人员）
    function initMyInfo() {
        var user = JSON.parse(sessionStorage.user);
        console.log(user);
        mine.username = user.name;
        mine.id = user.userId;
        mine.status = "online";
        mine.avatar = user.headImg;
    }

    initMyInfo();
    layui.use('layim', function (layim) {
        var layim = layui.layim;
        layim.config({
            init: {
                //配置客户信息
                mine: mine
            }
            //开启客服模式
            , brief: true
        });
        //打开一个客服面板
        layim.chat(chats).chat(chat2);
        // layim.setChatMin(); //收缩聊天面板

        layim.on('sendMessage', function (res) {
            // 消息内容
            var content = res.mine.content;
            // 接收者id
            var receiver = res.to.id;
            send({content: content, receiver: receiver});
        });

        var websocket = null;
        if ('WebSocket' in window) {
            websocket = new WebSocket(im.url.websocket);
        }
        else {
            alert('Not support websocket')
        }

        websocket.onerror = function () {
            console.log("websocket error");
        };

        websocket.onopen = function (event) {
            console.log('open');
            var user = JSON.parse(sessionStorage.user);
            var authMessage = {username: user.name, password: user.pwd};
            send(authMessage);
        };

        //接收到消息的回调方法   event.data
        websocket.onmessage = function (event) {
            console.log(event);
            var sender = event.data.sender;
            // TODO 如果是一个新sender ，调用.chat方法，添加一个新聊天面板
            layim.getMessage(event.data); //res.data即你发送消息传递的数据（阅读：监听发送的消息）
        };

        websocket.onclose = function () {
            console.log('close')
        };

        window.onbeforeunload = function () {
            websocket.close();
        };

        function closeWebSocket() {
            websocket.close();
        }

        function send(msg) {
            websocket.send(msg);
        }
    });
</script>
</body>
</html>