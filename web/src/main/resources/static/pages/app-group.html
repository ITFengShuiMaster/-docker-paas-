<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Index</title>
	<link rel="stylesheet" href="../lib/layui/css/layui.css" media="all">
	<link rel="stylesheet" href="../lib/element/index.css"/>
	<link rel="stylesheet" href="//unpkg.com/iview/dist/styles/iview.css">
	<script src="../lib/vue/vue.js"></script>
	<script src="../lib/element/index.js"></script>
	<script src="../lib/jquery/jquery-3.2.1.js"></script>
	<script src="../lib/layui/layui.js"></script>
	<script src="../lib/echarts/echarts.js"></script>
	<script src="../js/common.js"></script>
</head>

<body>
<div id="appGroup">
	<div style="padding: 20px">
		<el-breadcrumb separator="/">
			<el-breadcrumb-item :to="{ path: '/index.html' }">首页</el-breadcrumb-item>
			<el-breadcrumb-item><a href="#">我的应用</a></el-breadcrumb-item>
			<el-breadcrumb-item>应用组</el-breadcrumb-item>
		</el-breadcrumb>
		<div style="padding-left: 20px; padding-right: 20px; margin-top:25px;display: flex">
			<p style="font-size: 20px; color: black; width: 30%">test</p>
			<div style="text-align: right; display: inline-block; width: 70%">
				<div style="display: inline-block">
					<el-button-group>
						<el-button @click="open()">开启</el-button>
						<el-button @click="close()">关闭</el-button>
						<el-button @click="restart()">重启</el-button>
						<el-button @click="open_ssh()">命令行</el-button>
					</el-button-group>
				</div>
				<div style="margin-left: 20px; display: inline-block;">
					<el-button-group>
						<el-button :type="typeTopo" @click="clickTopo">拓扑图
						</el-button>
						<el-button :type="typeList" @click="clickList">列表
						</el-button>
					</el-button-group>
				</div>
			</div>
		</div>
		<div v-if="selectTopo" id="groupCharts" style="background: white; margin: 30px; height: 500px;">
		</div>
		<div v-else style="background: white; margin: 30px; height: 500px;">
			<div style="margin-top: 20px">
				<el-button @click="startBatch" :disabled="selectAppsId.length === 0">批量启动</el-button>
				<el-button @click="stopBatch" :disabled="selectAppsId.length === 0">批量关闭</el-button>
				<el-button @click="restartBatch" :disabled="selectAppsId.length === 0">批量重启</el-button>
			</div>
			<el-table
					@selection-change="selectionChange"
					stripe
					:data="groupApps"
					style="width: 100%">
				<el-table-column
						type="selection"
						width="55">
				</el-table-column>
				<el-table-column
						prop="name"
						label="应用名称">
					<template slot-scope="scope">
						<p style="color: #1890ff">{{scope.row.name}}</p>
					</template>
				</el-table-column>
				<el-table-column
						prop="appCreateMethodName"
						label="创建方式">
				</el-table-column>
				<el-table-column
						prop="memoryUsed"
						label="内存">
					<template slot-scope="scope">
						<p>{{scope.row.memoryUsed}}MB</p>
					</template>
				</el-table-column>
				<el-table-column
						prop="status"
						label="状态">
					<template slot-scope="scope">
						<el-tag :type="scope.row.status === 0 ? 'info' : scope.row.status === 1 ? 'success':'danger'">
							{{scope.row.appStatusName}}
						</el-tag>
					</template>
				</el-table-column>
				<el-table-column
						prop="gmtCreate"
						label="创建时间">
					<template slot-scope="scope">
						<i class="el-icon-time"></i>
						<span style="margin-left: 10px">{{ scope.row.gmtCreate }}</span>
					</template>
				</el-table-column>
				<el-table-column label="操作">
					<template slot-scope="scope">
						<el-button size="mini" type="primary"
								   @click="startApp(scope.row.appId)">启动
						</el-button>
						<el-button size="mini" type="success"
								   @click="restartApp(scope.row.appId)">重启
						</el-button>
						<el-button size="mini" type="warning"
								   @click="stopApp(scope.row.appId)">关闭
						</el-button>
						<el-button size="mini" type="danger"
								   @click="deleteApp(scope.row.appId)">删除
						</el-button>
					</template>
				</el-table-column>
			</el-table>
		</div>
	</div>
</div>
</div>
<script>
    var appGroup = new Vue({
        el: '#appGroup',
        data: {
            appGroupId: 0,
            typeTopo: 'primary',
            typeList: '',
            selectTopo: true,
            groupApps: [],
            selectAppsId: []
        },
        methods: {
            getId(groupId) {
                this.appGroupId = groupId;
                console.log(groupId);
            },
            selectionChange(selection) {
                console.log(selection);
                this.selectAppsId = [];
                for (let i in selection) {
                    this.selectAppsId.push(selection[i].appId);
                }
            },
            clickTopo() {
                this.typeList = '';
                this.typeTopo = 'primary';
                this.selectTopo = true;
                initEcharts();
            },
            clickList() {
                this.typeTopo = '';
                this.typeList = 'primary';
                this.selectTopo = false;
                this.listGroupApps();
            },
            listGroupApps() {
                web.ajax({
                    url: web.url.listGroupApps + appGroup.appGroupId,
                    type: 'get',
                    success: function (res) {
                        // 将code转换为真正的message
                        for (let i in res.data) {
                            res.data[i].appStatusName = web.appStatusNames[res.data[i].status];
                            res.data[i].appCreateMethodName = web.appCreateMethodNames[res.data[i].createMethod];
                        }
                        appGroup.groupApps = res.data;
                    }
                }, this);
            },
            startBatch() {
                web.ajax({
                    url: web.url.batchStartApp,
                    data: {
                        appIds: appGroup.selectAppsId
                    },
                    type: 'post',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            },
            stopBatch() {
                web.ajax({
                    url: web.url.batchStopApp,
                    data: {
                        appIds: appGroup.selectAppsId
                    },
                    type: 'post',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            },
            restartBatch() {
                web.ajax({
                    url: web.url.batchRestartApp,
                    data: {
                        appIds: appGroup.selectAppsId
                    },
                    type: 'post',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            },
            startApp(id) {
                web.ajax({
                    url: web.url.startApp + id,
                    type: 'get',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            },
            stopApp(id) {
                web.ajax({
                    url: web.url.stopApp + id,
                    type: 'get',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            },
            restartApp(id) {
                web.ajax({
                    url: web.url.restartApp + id,
                    type: 'get',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            },
            deleteApp(id) {
                web.ajax({
                    url: web.url.deleteApp + id,
                    type: 'post',
                    success: function (res) {
                        if (res.data.code === web.result.success) {
                            appGroup.$message.success(res.data.message);
                            appGroup.listGroupApps();
                        } else {
                            appGroup.$message.error(res.data.message);
                        }
                    }
                }, this);
            }
        },
        mounted() {
            initEcharts(this.appGroupId);
        }
    });

    function initEcharts(groupId) {
        var myChart = echarts.init(document.getElementById('groupCharts'));
        myChart.showLoading();
        var appsName = [];
        var relations = [];
        web.ajax({
                url: web.url.getAppRealtions + groupId,
                type: 'get',
                success: function (res) {
                    if (res.code === web.result.success) {
                        for (let i in res.data.appName) {
                            appsName[i].name = res.data.appName[i];
                        }
                        for (let i in res.data.data) {
                            for (let j = 0; j <= res.data.data.length - i; j++) {
                                relations.source = res.data.appName[i];
                                relations.target = res.data.appName[j];
                            }
                        }
                    }
                },
                complete: function () {
                    myChart.hideLoading();
                }
            }

            ,
            appGroup
        )
        ;
        var option = {
            title: {
                text: '应用组拓扑图'
            },
            tooltip: {},
            animationDurationUpdate: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    type: 'graph',
                    hoverAnimation: true,
                    layout: 'force',
                    roam: true,
                    draggable: true,
                    // 可设置图片链接和base64编码
                    symbol: ['circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'],
                    edgeSymbol: ['circle', 'arrow'],
                    focusNodeAdjacency: true,
                    force: {
                        repulsion: 100,
                    },
                    itemStyle: {
                        shadowColor: 'rgba(0, 0, 0, 0.5)',
                        shadowBlur: 10
                    },
                    data: appsName,
                    links: relations,
                }
            ]
        };
        myChart.setOption(option);
    }
</script>
</body>
</html>