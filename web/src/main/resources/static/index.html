<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <link rel="stylesheet" href="lib/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="lib/element/index.css"/>
    <link rel="stylesheet" href="//unpkg.com/iview/dist/styles/iview.css">
    <script src="lib/vue/vue.js"></script>
    <script src="lib/element/index.js"></script>
    <script src="lib/jquery/jquery-3.2.1.js"></script>
    <script src="lib/layui/layui.js"></script>
    <script src="lib/iview/iView.min.js"></script>
</head>

<body>
<el-container id="app">

    <el-aside style="width: 270px;">
        <el-header style="height:68px; background: #002140;">
            <img src="./img/logo.png" style="float: left; margin-top: 12px;padding-right: 10px">
            <div class="logo_text" style="color: white;padding: 20px">Docker</div>
        </el-header>
        <el-menu
                id="test"
                default-active="0"
                class="el-menu-vertical-marketApp"
                @select="selectPage"
                background-color="#001529"
                text-color="#fff"
                active-text-color="#ffffff">
            <el-menu-item index="0">
                <i class="el-icon-more-outline"></i>
                <span slot="title">总览</span>
            </el-menu-item>
            <el-submenu index="10001">
                <template slot="title">
                    <i class="el-icon-plus"></i>
                    <span>创建应用</span>
                </template>
                <el-menu-item index="1">从源码创建</el-menu-item>
                <el-menu-item index="2">从Docker镜像创建</el-menu-item>
                <el-menu-item index="3">从应用市场安装</el-menu-item>
            </el-submenu>
            <el-submenu index="10002">
                <template slot="title">
                    <i class="el-icon-menu"></i>
                    <span slot="title">我的应用</span>
                </template>
                <el-submenu v-for="(group,index) in groups_apps" :index="'300'+index">
                    <template slot="title">
                        <div>
                            <i class="el-icon-plus"></i>
                            <span>{{group.groupName}}</span>
                        </div>
                    </template>
                    <el-menu-item v-for="(app,appIndex) in group.apps" :index="app.appId+10000+''">
                        <div>
                            <span>{{app.name}}</span>
                        </div>
                    </el-menu-item>
                </el-submenu>
            </el-submenu>
            <el-menu-item index="5">
                <i class="el-icon-tickets"></i>
                <span slot="title">财务中心</span>
            </el-menu-item>
        </el-menu>
    </el-aside>

    <el-container>
        <el-header style="padding:0px;width: 100%">
            <el-card shadow="always">
                <el-col :span="20" align="right" style="font-size: 20px; color: #409EFF; margin-top: 0px">
                    <el-popover
                            placement="bottom"
                            width="400"
                            trigger="click">
                        <el-button slot="reference" type="text">
                            <el-badge is-dot>
                                <i class="el-icon-bell" style="font-size: 20px"></i>
                            </el-badge>
                        </el-button>
                        <template>
                            <el-tabs v-model="activeName" stretch>
                                <el-tab-pane name="first">
                                    <span slot="label">公告({{noticenum}})</span>
                                    <div @click="dialogVisible = true;getcurrent_message_notice(notice)"
                                         v-for="notice in noticerecord"
                                         style="border-bottom: 1px solid #e8e8e8; padding-bottom: 12px; padding-top: 12px">
                                        <p style="font-size: 14px; margin-bottom: 8px">
                                            {{notice.title}}
                                            <el-badge is-dot style="float: right">
                                            </el-badge>
                                        </p>

                                        <p style="font-size: 12px; margin-bottom: 5px; color: rgba(0,0,0,.45)">查看详情</p>
                                        <p style="font-size: 8px; color:rgba(0,0,0,.45)">
                                            {{notice.createTime}}</p>
                                    </div>
                                    <div style="color: rgba(0,0,0,.45); text-align: center; margin-top: 12px; font-size: 14px">
                                        查看历史消息
                                    </div>
                                </el-tab-pane>
                                <el-tab-pane name="second">
                                    <span slot="label">消息({{messagenum}})</span>
                                    <div @click="dialogVisible = true;getcurrent_message_notice(message)"
                                         v-for="message in messagerecord"
                                         style="border-bottom: 1px solid #e8e8e8; padding-bottom: 12px; padding-top: 12px">
                                        <p style="font-size: 14px; margin-bottom: 8px">
                                            {{message.content}}
                                            <el-badge is-dot style="float: right">
                                            </el-badge>
                                        </p>

                                        <p style="font-size: 12px; margin-bottom: 5px; color: rgba(0,0,0,.45)">查看详情</p>
                                        <p style="font-size: 8px; color:rgba(0,0,0,.45)">
                                            {{message.createTime}}</p>
                                    </div>
                                    <div style="color: rgba(0,0,0,.45); text-align: center; margin-top: 12px; font-size: 14px">
                                        查看历史消息
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </template>
                    </el-popover>
                </el-col>
                <el-col :span="2" align="right">
                    <img src="img/logo.png">
                    <el-dropdown @command="handleCommand">
                        <span style="font-size: 18px; color: #409EFF;">{{username}}</span>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="1">退出登录</el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                </el-col>
            </el-card>
        </el-header>

        <el-main id="content">


        </el-main>

    </el-container>
    <el-dialog
            :visible.sync="dialogVisible"
            width="30%">
        <span slot="title" style="font-size: 28px">{{currentdata.title}}</span>
        <span style="font-size: 20px">{{currentdata.content}}</span>
        <span slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="dialogVisible = false">确 定</el-button>
        </span>
    </el-dialog>

</el-container>

<script>
    var vm = new Vue({
        el: '#app',
        data: {
            dialogVisible: false,
            bodyHeight: $(window).height(),
            // 左侧导航栏的应用组和组里的app
            groups_apps: [],
            id: 1,
            imageUrl: '',
            username: '',
            isCollapse: false,
            pageArr: ['pages/home.html', 'pages/create_by_code.html', 'pages/create_by_docker.html', 'pages/create_by_market.html', 'pages/appinfo.html', 'pages/financialcenter.html'],
            teamArr: ['团队一', '团队二'],
            dataArr: ['假数据中心', '真数据中心'],
            //通告消息界面展开的默认显示
            activeName: 'first',
            appList: [],
            //消息信息
            messagerecord: [],
            //通告信息
            noticerecord: [],
            messagenum: 0,
            noticenum: 0,
            currentdata: "",
        },
        methods: {
            openSubMenu(index, indexPath) {
                console.log("openSubMenu" + index, indexPath);
            },
            handleCommand(command) {
                this.$message("退出");
            },
            //获取用户信息（暂时只使用了name）
            init_usrInf() {
                $.ajax({
                    type: "get",
                    url: 'http://localhost:8080/tianyu-paas/users/info/' + this.id,
                    data: {},
                    success: function (result) {
                        if (result.code === 1) {
                            vm.username = result.data.name;
                        } else {
                        }
                    },
                    error: function () {
                        console.log("失败")
                    }
                })
            },
            //获取通知
            getNotice() {
                $.ajax({
                    type: "get",
                    url: 'http://localhost:8080/tianyu-paas/user-notices',
                    success: function (result) {
                        if (result.code) {
                            vm.noticerecord = result.data;
                            //获取通知长度
                            vm.noticenum = Object.keys(result.data).length
                        } else {
                        }
                    },
                    error: function () {
                        console.log("失败")
                    }
                })
            },
            //获取消息
            getMessage() {
                $.ajax({
                    type: "get",
                    url: 'http://localhost:8080/tianyu-paas/userMessages',
                    data: {},
                    success: function (result) {
                        if (result.code) {
                            vm.messagerecord = result.data;
                            //获取消息长度
                            vm.messagenum = Object.keys(result.data).length;
                        } else {
                        }
                    },
                    error: function () {
                        console.log("失败")
                    }
                })
            },
            //设置消息为已读
            setMessageRead(order) {
                $.ajax({
                    type: "put",
                    url: 'http://localhost:8080/tianyu-paas/userMessages',
                    data: {
                        messageId: order.messageId,
                    },
                    success: function (result) {
                        if (result.code) {

                        } else {
                        }
                    },
                    error: function () {
                        console.log("失败")
                    }
                })
            },
            //设置通知为已读
            setNoticeRead(order) {
                $.ajax({
                    type: "get",
                    url: 'http://localhost:8080/tianyu-paas/user-notices/' + order.noticeId,

                    success: function (result) {
                        if (result.code === 1) {

                        } else {

                        }
                    },
                    error: function () {
                        console.log("失败")
                    }
                })
            },
            //获取app列表信息
            myAppList() {
                var that = this;
                $.ajax({
                    type: 'get',
                    url: '/tianyu-paas/actions/info',
                    success: function (data) {
                        if (data.code === 1) {
                            that.appList = data.data
                        }
                        else {
                            console.log(data.message)
                        }
                    },
                    error: function () {
                        console.log("error")
                    }
                })
            },
            // 选择页面
            selectPage(index, indexPath) {
                // 主要就是通过jquery的load方法，加内容加载到元素上
                if (index > 10000) {
                    $('#content').load("pages/appinfo.html", function (response, message, xhr) {
                        appinfo.getId(index - 10000);
                    });
                }
                else {
                    $('#content').load(this.pageArr[index], function (response, message, xhr) {
                    });
                }
            },
            //TODO 登出
            logout() {

            },
            handleOpen(key, keyPath) {
                console.log(key, keyPath);
                // 打开我的应用选项卡
                if (key >= 3000 && key < 4000) {
                    var id = this.groups_apps[key - 3000].appGroupId;
                    console.log(id);
                }
            },
            handleClose(key, keyPath) {
                console.log(key, keyPath);
            },
            contact_customer_service() {
                layui.use('layim', function (layim) {
                    var $ = layui.$; //由于layer弹层依赖jQuery，所以可以直接得到
                    //基础配置
                    layim.config({
                        brief: true, //是否简约模式（如果true则不显示主面板）
                        minRight: '20px',
                        right: '10px',
                        init: {
                            mine: {
                                username: "纸飞机" //我的昵称
                                , id: "100000" //我的ID
                                , status: "online" //在线状态 online：在线、hide：隐身
                                , sign: "在深邃的编码世界，做一枚轻盈的纸飞机" //我的签名
                                , avatar: "http://tp1.sinaimg.cn/5619439268/180/40030060651/1" //我的头像
                            }
                        } //获取主面板列表信息


                        //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
                        , uploadImage: {
                            url: '', //接口地址
                            type: 'post', //默认post
                        }

                        //上传文件接口（返回的数据格式见下文），若不开启文件上传，剔除该项即可
                        , uploadFile: {
                            url: '', //接口地址
                            type: 'post', //默认post
                        }
                    }).chat({
                        name: '客服',
                        type: 'friend',
                        avatar: 'http://tp1.sinaimg.cn/5619439268/180/40030060651/1',
                        id: -2
                    }).on('sendMessage', function (res) {
                        var mine = res.mine;
                        var to = res.to; //对方的信息
                        //监听到上述消息后，就可以轻松地发送socket了，如：
                        websocket.send(JSON.stringify({
                            type: 'chatMessage' //随便定义，用于在服务端区分消息类型
                            , data: res
                        }));
                        //获取收到的消息
                        websocket.onmessage = function (res) {
                            res = JSON.parse(res);
                            if (res.emit === 'chatMessage') {
                                layim.getMessage(res.data); //res.data即你发送消息传递的数据（阅读：监听发送的消息）
                            }
                        };
                    }).setChatMin();
                });
            },

            //获取当前点击的通知或消息
            getcurrent_message_notice(data) {
                vm.currentdata = data;
            },

            //获取分组信息
            init_gruops() {
                $.get({
                    url: '/tianyu-paas/app-groups/groups-apps',
                    success: function (res) {
                        vm.groups_apps = res.data;
                    }
                })
            },
            getWindowHeight() {
                $("#test").height($(window).height() - 68)
            },
        },
        created() {
            this.myAppList();
            this.init_usrInf();
            this.getMessage();
            this.getNotice();
            this.init_gruops();
//            this.getWindowHeight()
            $("#test").height(this.bodyHeight - 68)

        },
        mounted() {
            this.contact_customer_service();
            this.selectPage(0, '')
        },
        beforeMount() {
            window.onresize = function () {
                this.bodyHeight = document.documentElement.clientHeight;
                if (document.getElementById('test') != null) {
                    $("#test").height(this.bodyHeight - 68)
                }
            }
        }
    });
</script>
</body>
</html>